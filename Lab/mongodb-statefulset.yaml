apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb-statefulset
spec:
  serviceName: mongodb-headless-service
  replicas: 2 # Assuming you reduced replicas for debugging, adjust as needed
  selector:
    matchLabels:
      app: mongodb-statefulset
  template:
    metadata:
      labels:
        app: mongodb-statefulset
    spec:
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: mongodb-statefulset
      terminationGracePeriodSeconds: 10
      initContainers:
        # --- NEW INIT CONTAINER FOR PERMISSIONS ---
        - name: fix-data-permissions
          image: busybox:latest # Light-weight image
          command: ["sh", "-c", "chown -R 999:999 /data/db && chmod -R 755 /data/db"]
          securityContext: # Run this initContainer as root to ensure it has permissions to change ownership
            runAsUser: 0 # Run as root
          volumeMounts:
            - name: mongodb-data
              mountPath: /data/db
        # --- END NEW INIT CONTAINER ---
        - name: init-mongodb-replica-set
          image: mongo:6.0.13
          command:
            - "bash"
            - "-c"
            - |
              if [[ "$(hostname)" == "mongodb-statefulset-0" ]]; then
                echo "Initiating replica set..."
                sleep 20
                MEMBERS="[{_id: 0, host: \"mongodb-statefulset-0.mongodb-headless-service:27017\"},{_id: 1, host: \"mongodb-statefulset-1.mongodb-headless-service:27017\"},{_id: 2, host: \"mongodb-statefulset-2.mongodb-headless-service:27017\"}]"
                echo "Replica set members: $MEMBERS"
                mongosh --eval "rs.initiate({ _id: \"rs0\", members: $MEMBERS });"
                echo "Replica set initiated."
              else
                echo "Not the primary pod (mongodb-statefulset-0), skipping replica set initiation."
              fi
          env:
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: MONGO_INITDB_ROOT_USERNAME
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: MONGO_INITDB_ROOT_PASSWORD
          volumeMounts:
            - name: mongodb-keyfile
              mountPath: /etc/mongodb-keyfile
            - name: mongodb-config
              mountPath: /etc/mongod.conf
              subPath: mongod.conf
            - name: mongodb-data
              mountPath: /data/db
      securityContext:
        fsGroup: 999 # Keep this for consistency and to assist if the initContainer is ever skipped
      containers:
        - name: mongodb
          image: mongo:6.0.13
          securityContext:
            runAsUser: 999
            runAsGroup: 999
          ports:
            - containerPort: 27017
              name: mongodb
          command: ["mongod", "--config", "/etc/mongod.conf"] # Revert to normal mongod command
          resources:
            requests:
              memory: "1Gi" # Increased resource requests as discussed
              cpu: "500m"
            limits:
              memory: "2Gi" # Increased resource limits
              cpu: "1000m"
          livenessProbe: # Uncommented probes, as mongod should now start
            exec:
              command:
                - mongosh
                - --eval
                - "db.adminCommand('ping').ok"
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
            successThreshold: 1
          readinessProbe: # Uncommented probes
            exec:
              command:
                - mongosh
                - --eval
                - "db.adminCommand('replSetGetStatus').ok || db.adminCommand('ping').ok"
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
            successThreshold: 1
          volumeMounts:
            - name: mongodb-data
              mountPath: /data/db
            - name: mongodb-config
              mountPath: /etc/mongod.conf
              subPath: mongod.conf
            - name: mongodb-keyfile
              mountPath: /etc/mongodb-keyfile
      volumes:
        - name: mongodb-config
          configMap:
            name: mongodb-config
        - name: mongodb-keyfile
          secret:
            secretName: mongodb-keyfile
            defaultMode: 0400
  volumeClaimTemplates:
    - metadata:
        name: mongodb-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi # Consider increasing this for real workloads
        storageClassName: custom-local-storage-class
